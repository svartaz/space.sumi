<html>
  <head>
    <script>
      const primes = [2];
      const primeNth = (i) => {
        while (primes.length <= i)
          for (let p = 3; ; p += 2) {
            if (primes.every((prime) => p % prime !== 0)) {
              primes.push(p);
              break;
            }
          }

        return primes[i];
      };

      const textToData = (text) => {
        const [lineHz, ...lines] = text
          .replace(" ", "")
          .split("\n")
          .map((line) => line.replace(/#.+/, ""))
          .filter((line) => line !== "");

        return [
          parseFloat(lineHz),
          lines.map((line) => {
            const muted = line.startsWith("m");
            line = line.replace(/^m/, "");

            const exponents = line
              .split(",")
              .map((numberString) => parseInt(numberString) || 0);
            const product = exponents
              .map((exponent, i) => primeNth(i) ** exponent)
              .reduce((a, b) => a * b, 1);

            return {
              muted,
              exponents,
              product,
              productLog2: Math.log2(product),
            };
          }),
        ];
      };
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();

      document.addEventListener("DOMContentLoaded", () => {
        const oscillators = [];

        const canvas = document.querySelector("canvas");
        const canvasContext = canvas.getContext("2d");
        canvasContext.imageSmoothingEnabled = false;

        const height = 12;
        const asY = (number) =>
          canvas.height * (1 / 2 - Math.log2(number) / height);

        const defaultCanvas = () => {
          canvasContext.fillStyle = "white";
          canvasContext.fillRect(0, 0, canvas.width, canvas.height);

          for (let e = -height / 2 + 1; e < height / 2; e++) {
            canvasContext.lineWidth = 1;
            canvasContext.strokeStyle = "lightgray";
            canvasContext.moveTo(0, asY(Math.pow(2, e)));
            canvasContext.lineTo(canvas.width, asY(Math.pow(2, e)));
            canvasContext.stroke();
          }
        };

        const widthBar = canvas.width / 96;
        const onInput = () => {
          // reset
          while (oscillators.length) oscillators.pop().stop();
          defaultCanvas();

          const [hz, data] = textToData(
            document.querySelector("textarea").value
          );
          const lengthExponents = Math.max(
            ...data.map(({ exponents }) => exponents.length)
          );

          const table = document.createElement("table");
          const tr = document.createElement("tr");
          tr.appendChild(document.createElement("th"));
          for (let indexTh = 0; indexTh < lengthExponents; indexTh++) {
            const th = document.createElement("th");
            th.textContent = `${primeNth(indexTh)}^`;
            tr.appendChild(th);
          }
          const thProduct = document.createElement("th");
          thProduct.textContent = "prod";
          tr.appendChild(thProduct);
          const thProductLog2 = document.createElement("th");
          thProductLog2.textContent = "log2";
          tr.appendChild(thProductLog2);
          tr.appendChild(document.createElement("th"));
          table.append(tr);

          data.forEach(
            ({ muted, exponents, product, productLog2 }, indexTone) => {
              // sound
              if (!muted) {
                const o = audioContext.createOscillator();
                o.type = "sine";
                o.frequency.value = hz * product;

                const gain = audioContext.createGain();
                gain.gain.value = 1 / (data.length + 1);
                gain.connect(audioContext.destination);

                o.connect(gain);
                o.start();

                oscillators.push(o);
              }

              // table
              const tr = document.createElement("tr");
              if (muted) tr.classList.add("muted");
              const th = document.createElement("th");
              th.textContent = `tone ${indexTone}`;
              tr.append(th);

              for (let indexTd = 0; indexTd < lengthExponents; indexTd++) {
                const td = document.createElement("td");
                td.textContent = exponents[indexTd] || 0;
                tr.append(td);
              }

              const tdProduct = document.createElement("td");
              tdProduct.textContent = product;
              tr.append(tdProduct);
              const tdProductLog2 = document.createElement("td");
              tdProductLog2.textContent = parseFloat(productLog2.toFixed(3));
              tr.append(tdProductLog2);

              table.append(tr);
              document.querySelector("table").replaceWith(table);

              // canvas
              let x = (canvas.width * (indexTone + 1)) / (data.length + 1);
              if (product === 1) {
                canvasContext.beginPath();
                canvasContext.arc(
                  x + widthBar / 2,
                  asY(1),
                  widthBar / 2,
                  0,
                  2 * Math.PI
                );
                canvasContext.fillStyle = muted ? "lightgray" : "gray";
                canvasContext.fill();
              }

              let productCurrent = 1;
              for (let indexExponent = 0; indexExponent < exponents.length; ) {
                if (exponents[indexExponent] === 0) {
                  indexExponent++;
                  continue;
                }

                const direction = exponents[indexExponent] < 0 ? "down" : "up";
                const productNew =
                  direction === "down"
                    ? productCurrent / primes[indexExponent]
                    : productCurrent * primes[indexExponent];

                if (direction === "down") exponents[indexExponent]++;
                else exponents[indexExponent]--;

                canvasContext.fillStyle =
                  indexExponent === 0
                    ? muted
                      ? "lightgray"
                      : "gray"
                    : `hsl(${
                        (360 * (indexExponent - 1)) / (primes.length - 1)
                      }deg 100% 50% / ${muted ? 1 / 4 : 1})`;
                canvasContext.fillRect(
                  x,
                  asY(productCurrent),
                  widthBar,
                  asY(productNew) - asY(productCurrent)
                );

                x += widthBar + 1;
                productCurrent = productNew;
              }
            }
          );
        };

        for (const input of document.querySelectorAll("textarea"))
          input.addEventListener("input", onInput);

        onInput();
      });
    </script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
      }

      html,
      body {
        inline-size: 100%;
        block-size: 100%;
      }

      body {
        font-family: sans-serif;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto 1fr;
        align-items: center;
        justify-items: center;
        gap: 1rem;
        padding: 1rem;
      }

      canvas {
        border: 1px solid black;
        margin: 0 auto;
        grid-column: span 2;
      }

      textarea {
        inline-size: 100%;
        block-size: 100%;
        resize: none;
      }

      table {
        inline-size: fit-content;
        block-size: fit-content;
      }

      tr.muted {
        color: lightgray;
      }
    </style>
  </head>
  <body>
    <canvas width="900" height="600"></canvas
    ><textarea>
# #: comment
# m: muted

# base frequency
110

# seventh
m1
m0,1
m-1,0,1
m-2,1,1
m-1,2
</textarea
    >
    <table></table>
  </body>
</html>

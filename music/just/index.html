<html>
  <head>
    <script>
      const arraySubtract = (a, b) => {
        const result = [];
        for (let i = 0; i < Math.max(a.length, b.length); i++)
          result[i] = (a[i] || 0) - (b[i] || 0);
        return result;
      };

      const textToData = (text) => {
        const [lineHz, ...lines] = text
          .replace(" ", "")
          .split("\n")
          .map((line) => line.trim().replace(/#.+/, ""))
          .filter((line) => line !== "");

        return [
          parseFloat(lineHz),
          lines.map((line) => {
            const muted = line.startsWith("m");
            line = line.replace(/^m */, "");

            const product = line
              .split(/ +/g)
              .map((it) =>
                it.startsWith("/") ? 1 / Number(it.slice(1)) : Number(it)
              )
              .reduce((a, b) => a * b, 1);

            return {
              muted,
              product,
              productLog2: Math.log2(product),
            };
          }),
        ];
      };
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();

      document.addEventListener("DOMContentLoaded", () => {
        const oscillators = [];

        const canvas = document.querySelector("canvas");
        const canvasContext = canvas.getContext("2d");
        canvasContext.imageSmoothingEnabled = false;
        canvas.width = canvas.getBoundingClientRect().width;
        canvas.height = canvas.getBoundingClientRect().height;

        const onInput = () => {
          // reset
          while (oscillators.length) {
            const { oscillator, gain } = oscillators.pop();
            gain.gain.setTargetAtTime(0, audioContext.currentTime, 0.03);
            oscillator.stop(audioContext.currentTime + 0.05);
          }

          const [hz, data] = textToData(
            document.querySelector("textarea").value
          );

          const log2Max = Math.max(1, ...data.map((it) => it.productLog2));
          const log2Min = Math.min(1, ...data.map((it) => it.productLog2));

          const height = 12;

          // fit log2 value in min to max range
          const asY = (number) =>
            (canvas.height * (Math.log2(number) - log2Min)) /
            (log2Max - log2Min);

          canvasContext.clearRect(0, 0, canvas.width, canvas.height);
          for (let e = -100; e < 101; e++) {
            canvasContext.lineWidth = 1;
            canvasContext.strokeStyle = "lightgray";
            canvasContext.beginPath();
            canvasContext.moveTo(0, asY(2 ** e));
            canvasContext.lineTo(canvas.width, asY(2 ** e));
            canvasContext.stroke();
            canvasContext.closePath();
          }

          const tbody = document.createElement("tbody");
          data.forEach(
            ({ muted, exponents, product, productLog2 }, indexTone) => {
              // sound
              if (!muted) {
                const o = audioContext.createOscillator();
                o.type = "sine";
                o.frequency.value = hz * product;

                const g = audioContext.createGain();
                g.gain.value = 1 / (data.filter((it) => !it.muted).length + 1);
                g.connect(audioContext.destination);

                o.connect(g);
                o.start();

                oscillators.push({ oscillator: o, gain: g });
              }

              // table
              const tr = document.createElement("tr");
              if (muted) tr.classList.add("muted");
              const th = document.createElement("th");
              th.textContent = `tone ${indexTone}`;
              tr.append(th);

              const tdProduct = document.createElement("td");
              tdProduct.textContent = product;
              tr.append(tdProduct);
              const tdProductLog2 = document.createElement("td");
              tdProductLog2.textContent = parseFloat(productLog2.toFixed(3));
              tr.append(tdProductLog2);

              tbody.append(tr);
              document.querySelector("tbody").replaceWith(tbody);

              // canvas
              const widthBar = canvas.width / data.length;
              if (product === 1) {
                canvasContext.beginPath();
                canvasContext.arc(
                  widthBar * (indexTone + 0.5),
                  asY(1),
                  widthBar / 2,
                  0,
                  2 * Math.PI
                );
                canvasContext.fillStyle = muted ? "lightgray" : "gray";
                canvasContext.fill();
                canvasContext.closePath();
              } else {
                canvasContext.fillStyle =
                  product === 1
                    ? muted
                      ? "lightgray"
                      : "gray"
                    : `hsl(${360 * productLog2}deg 100% 50% / ${
                        muted ? 1 / 4 : 1
                      })`;
                canvasContext.fillRect(
                  widthBar * indexTone,
                  asY(1),
                  widthBar,
                  asY(product) - asY(1)
                );
              }
            }
          );
        };

        for (const input of document.querySelectorAll("textarea"))
          input.addEventListener("input", onInput);

        onInput();
      });
    </script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
      }

      html,
      body {
        inline-size: 100%;
        block-size: 100%;
      }

      body {
        font-family: sans-serif;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        align-items: center;
        justify-items: center;
        gap: 1rem;
        padding: 1rem;
      }

      canvas {
        grid-column: span 2;
        block-size: 100%;
        inline-size: 100%;
        aspect-ratio: auto;

        border: 1px solid black;
      }

      textarea {
        inline-size: 100%;
        block-size: 100%;
        resize: none;
      }

      table {
        inline-size: fit-content;
        block-size: fit-content;
      }

      tr.muted {
        color: lightgray;
      }
    </style>
  </head>
  <body>
    <canvas></canvas
    ><textarea>
# #: comment
# m: muted

# base frequency
55

# dominant seventh
m4
m5
m6
m7

# major seventh
m4
m5
m6
m7.5

# minor seventh
m4
m4.8
m6
m7
</textarea
    >
    <table>
      <thead>
        <th></th>
        <th>product</th>
        <th>log2</th>
      </thead>
      <tbody></tbody>
    </table>
  </body>
</html>
